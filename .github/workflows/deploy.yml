name: Deploy

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # push:
  #   branches: [main]
  #   paths:
  #     - src/**
  #     - public/**
  #     - scripts/**
  #     - next.config.js
  #     - package.json
  #     - pnpm-lock.yaml
  # pull_request:
  #   branches: [main]
  #   paths:
  #     - src/**
  #     - public/**
  #     - scripts/**
  #     - next.config.js
  #     - package.json
  #     - pnpm-lock.yaml

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # åˆ‡æ¢åˆ†æ”¯
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      # ç”Ÿæˆç‰ˆæœ¬å·ï¼ˆåŸºäºæ—¶é—´ï¼‰
      - name: Generate version
        id: version
        run: |
          VERSION=$(date +%Y%m%d%H%M%S)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 10
          run_install: false

      # ä½¿ç”¨ node:lts/jod
      - name: use Node.js lts/jod
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/jod'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm i

      # build
      - name: Build
        run: pnpm run publish-t1

      # tar
      - name: Tar dist
        run: tar zcf build.tar.gz --exclude=build/cache build public scripts package.json pnpm-lock.yaml .npmrc next.config.js Dockerfile docker-compose.yaml

      # Deploy to server
      - name: Deploy to server
        id: deploy
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.REMOTE_PREVIEW_HOST }}
          username: ${{ secrets.REMOTE_PREVIEW_USER }}
          key: ${{ secrets.ACCESS_TOKEN }}
          source: 'build.tar.gz'
          target: /web/next

      # é›¶åœæœºéƒ¨ç½²
      - name: Zero-downtime deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_PREVIEW_HOST }}
          username: ${{ secrets.REMOTE_PREVIEW_USER }}
          key: ${{ secrets.ACCESS_TOKEN }}
          script: |
            # è¿›å…¥å·¥ä½œç›®å½•
            cd /web/next
            echo "Working directory: $(pwd)"

            # è§£å‹æ–°ç‰ˆæœ¬æ–‡ä»¶
            echo "Extracting new build..."
            tar zxf build.tar.gz
            rm build.tar.gz

            # =====================================================
            # é…ç½®å˜é‡é›†ä¸­å®šä¹‰åŒºåŸŸ
            # =====================================================

            # åŸºç¡€é…ç½®
            IMAGE_NAME="next"
            VERSION=$(date +%Y%m%d%H%M%S)

            # é•œåƒæ ‡ç­¾å®šä¹‰
            NEW_IMAGE_TAG="${IMAGE_NAME}:${VERSION}"
            CURRENT_IMAGE_TAG="${IMAGE_NAME}:current"
            PREVIOUS_IMAGE_TAG="${IMAGE_NAME}:previous"

            # å¤‡ä»½æ–‡ä»¶å®šä¹‰ï¼ˆæ—¶é—´æˆ³å‘½å - éƒ¨ç½²æˆåŠŸåå¤‡ä»½ç­–ç•¥ï¼‰
            # æ ¼å¼: build-backup-YYYYMMDDHHMMSS.tar.gz
            # ç­–ç•¥: åªå¤‡ä»½éƒ¨ç½²æˆåŠŸçš„ç‰ˆæœ¬ï¼Œä¿ç•™æœ€è¿‘2ä»½
            BACKUP_TIMESTAMP=$(date +%Y%m%d%H%M%S)
            VERSION_BACKUP="build-backup-${BACKUP_TIMESTAMP}.tar.gz"

            # å¥åº·æ£€æŸ¥é…ç½®
            MAX_RETRIES=10
            RETRY_DELAY=3
            HEALTH_CHECK_URL="http://localhost:8000/api/health"
            HEALTH_CHECK_PASSED=false

            # =====================================================
            # è¾“å‡ºé…ç½®ä¿¡æ¯ - å¢å¼ºç‰ˆæœ¬
            # =====================================================
            echo "ğŸš€ Starting Deployment..."
            echo "Deploying version: $VERSION"
            echo "Environment: PRODUCTION"
            echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
            echo ""
            echo "ğŸ“‹ Configuration Details:"
            echo "  APP_NAME: $APP_NAME"
            echo "  VERSION: $VERSION"
            echo "  NEW_IMAGE_TAG: $NEW_IMAGE_TAG"
            echo "  CURRENT_IMAGE_TAG: $CURRENT_IMAGE_TAG"
            echo "  PREVIOUS_IMAGE_TAG: $PREVIOUS_IMAGE_TAG"
            echo "  VERSION_BACKUP: $VERSION_BACKUP"
            echo "  HEALTH_CHECK_URL: $HEALTH_CHECK_URL"
            echo "  MAX_RETRIES: $MAX_RETRIES"
            echo "  RETRY_DELAY: ${RETRY_DELAY}s"
            echo ""

            # =====================================================
            # è§£å‹æ–°ç‰ˆæœ¬ï¼ˆä¿ç•™build.tar.gzç”¨äºåç»­å¤‡ä»½ï¼‰
            # =====================================================
            echo "ğŸ“‚ Extraction Phase:"
            echo "  ğŸ“¦ Extracting new build..."
            tar zxf build.tar.gz
            echo "  âœ“ New version extracted successfully (build.tar.gz preserved for backup)."
            echo ""

            # =====================================================
            # å¥åº·æ£€æŸ¥å‡½æ•°å®šä¹‰ - æ¨¡å—åŒ–å‡çº§ç‰ˆæœ¬
            # =====================================================

            # å¥åº·æ£€æŸ¥å‡½æ•°
            perform_health_check() {
                local url="$1"
                local max_retries="${2:-$MAX_RETRIES}"
                local retry_delay="${3:-$RETRY_DELAY}"

                echo "ğŸ¥ Performing health check at: $url"

                for i in $(seq 1 $max_retries); do
                    echo "  ğŸ“Š Attempt $i/$max_retries: Checking health at $url..."
                    if curl --fail --silent --show-error --connect-timeout 5 --max-time 10 "$url"; then
                        echo "  âœ… Health check passed!"
                        return 0
                    fi
                    if [ $i -lt $max_retries ]; then
                        echo "  â³ Health check failed. Retrying in $retry_delay seconds..."
                        sleep $retry_delay
                    else
                        echo "  âŒ Health check failed after $max_retries attempts."
                    fi
                done

                echo "  ğŸ’¥ Health check failed completely."
                return 1
            }

            # =====================================================
            # Docker é•œåƒæ„å»ºé˜¶æ®µ
            # =====================================================

            echo "ğŸ³ Docker Build Phase:"
            echo "  ğŸ”¨ Building new image: $NEW_IMAGE_TAG"
            docker build -t "$NEW_IMAGE_TAG" .
            echo "  âœ… Image built successfully."
            echo ""

            # =====================================================
            # Docker é›¶åœæœºéƒ¨ç½²å‡½æ•°å®šä¹‰
            # =====================================================

            # Docker é•œåƒç‰ˆæœ¬ç®¡ç†å‡½æ•°
            manage_docker_images() {
                echo "ğŸ·ï¸ Docker Image Management Phase:"

                # æ£€æŸ¥å½“å‰æ˜¯å¦æœ‰è¿è¡Œçš„å®¹å™¨
                local current_container=$(docker ps -q --filter "name=${APP_NAME}")

                if [ ! -z "$current_container" ]; then
                    echo "  ğŸ” Found running container: $current_container"

                    # å¤‡ä»½å½“å‰é•œåƒæ ‡ç­¾
                    local current_image=$(docker inspect --format='{{.Config.Image}}' $current_container 2>/dev/null || echo "")
                    if [ ! -z "$current_image" ] && [ "$current_image" != "$NEW_IMAGE_TAG" ]; then
                        echo "  ğŸ“¦ Backing up current image as previous:"
                        echo "    $current_image â†’ $PREVIOUS_IMAGE_TAG"
                        docker tag "$current_image" "$PREVIOUS_IMAGE_TAG" 2>/dev/null || true
                        echo "  âœ… Image backup completed."
                    else
                        echo "  â„¹ï¸  No image backup needed."
                    fi
                else
                    echo "  â„¹ï¸  No running container found (first deployment)."
                fi

                # æ ‡è®°æ–°é•œåƒä¸ºå½“å‰ç‰ˆæœ¬
                echo "  ğŸ·ï¸ Tagging new image as current version..."
                docker tag "$NEW_IMAGE_TAG" "$CURRENT_IMAGE_TAG"
                echo "  âœ… Image tagging completed."
                echo ""
            }

            # Docker Compose é…ç½®æ›´æ–°å‡½æ•°
            update_docker_compose() {
                echo "ğŸ“ Docker Compose Configuration Update:"
                echo "  ğŸ“‹ Before update - Current image line:"
                grep "image:" docker-compose.yaml | head -1

                echo "  ğŸ”§ Updating docker-compose.yaml with new image: $CURRENT_IMAGE_TAG"
                sed -i "s|image: [^[:space:]#]*|image: ${CURRENT_IMAGE_TAG}|" docker-compose.yaml

                echo "  ğŸ“‹ After update - New image line:"
                grep "image:" docker-compose.yaml | head -1
                echo "  âœ… Configuration update completed."
                echo ""
            }

            # Docker é›¶åœæœºéƒ¨ç½²å‡½æ•°
            deploy_with_docker() {
                echo "ğŸš€ Docker Zero-Downtime Deployment Phase:"
                echo "  ğŸ”„ Starting zero-downtime deployment..."

                # é‡æ–°åˆ›å»ºå¹¶å¯åŠ¨å®¹å™¨ï¼ˆè¿™ä¼šå…ˆå¯åŠ¨æ–°å®¹å™¨ï¼Œå†åœæ­¢æ—§å®¹å™¨ï¼‰
                if docker compose up -d --force-recreate --remove-orphans; then
                    echo "  âœ… Docker Compose deployment successful!"

                    # ç­‰å¾…æ–°å®¹å™¨å¯åŠ¨
                    echo "  â³ Waiting for new container to fully start..."
                    sleep 10
                    echo "  âœ… Container startup completed."
                    return 0
                else
                    echo "  âŒ Docker Compose deployment failed!"
                    return 1
                fi
            }

            # =====================================================
            # æ‰§è¡Œ Docker éƒ¨ç½²æµç¨‹
            # =====================================================

            # æ‰§è¡Œé•œåƒç®¡ç†
            manage_docker_images

            # æ›´æ–°é…ç½®æ–‡ä»¶
            update_docker_compose

            # æ‰§è¡Œé›¶åœæœºéƒ¨ç½²
            if ! deploy_with_docker; then
                echo "ğŸ’¥ Docker deployment failed! Will attempt rollback later."
                DOCKER_DEPLOY_FAILED=true
            else
                echo "ğŸ‰ Docker deployment phase completed successfully!"
                DOCKER_DEPLOY_FAILED=false
            fi
            echo ""

            # =====================================================
            # è‡ªåŠ¨å›é€€æœºåˆ¶å‡½æ•°å®šä¹‰
            # =====================================================

            # Docker é•œåƒçº§å›é€€å‡½æ•°
            rollback_docker_image() {
                echo "ğŸ”„ Docker Image Rollback Phase:"

                # æ£€æŸ¥æ˜¯å¦æœ‰ä¹‹å‰çš„é•œåƒå¯ä»¥å›æ»š
                if docker image inspect "$PREVIOUS_IMAGE_TAG" >/dev/null 2>&1; then
                    echo "  ğŸ“¦ Rolling back to previous Docker image: $PREVIOUS_IMAGE_TAG"

                    # æ›´æ–° docker-compose.yaml ä½¿ç”¨ä¹‹å‰çš„é•œåƒ
                    sed -i "s|image: [^[:space:]#]*|image: ${PREVIOUS_IMAGE_TAG}|" docker-compose.yaml

                    # é‡æ–°å¯åŠ¨æœåŠ¡
                    echo "  ğŸ”„ Restarting services with previous image..."
                    docker compose down --remove-orphans || true
                    docker compose up -d

                    # ç­‰å¾…å›æ»šå®Œæˆ
                    echo "  â³ Waiting for rollback to complete..."
                    sleep 10

                    return 0
                else
                    echo "  âŒ No previous Docker image available for rollback!"
                    return 1
                fi
            }

            # æ–‡ä»¶çº§å›é€€å‡½æ•°ï¼ˆå¢å¼ºç‰ˆæœ¬ï¼‰
            rollback_build_files() {
                echo "ğŸ“ File-Level Rollback Phase:"

                # æŸ¥æ‰¾æœ€æ–°çš„å¤‡ä»½æ–‡ä»¶
                LATEST_BACKUP=$(ls -t build-backup-*.tar.gz 2>/dev/null | head -1)

                if [ -n "$LATEST_BACKUP" ] && [ -f "$LATEST_BACKUP" ]; then
                    echo "  ğŸ“¦ Rolling back to latest backup: $LATEST_BACKUP"

                    # æ¢å¤å¤‡ä»½ç‰ˆæœ¬
                    echo "  ğŸ”„ Restoring backup files..."
                    rm -rf build 2>/dev/null || true
                    tar zxf "$LATEST_BACKUP"
                    echo "  âœ… Backup files restored."

                    # é‡å»ºé•œåƒ
                    echo "  ğŸ”¨ Rebuilding image from backup..."
                    local backup_image_tag="${APP_NAME}:backup-$(date +%Y%m%d%H%M%S)"
                    docker build -t "$backup_image_tag" .
                    docker tag "$backup_image_tag" "$CURRENT_IMAGE_TAG"

                    # æ›´æ–°é…ç½®å¹¶é‡å¯
                    sed -i "s|image: [^[:space:]#]*|image: ${CURRENT_IMAGE_TAG}|" docker-compose.yaml
                    docker compose down --remove-orphans || true
                    docker compose up -d

                    echo "  â³ Waiting for file rollback to complete..."
                    sleep 10

                    return 0
                else
                    echo "  âŒ No backup files available for rollback!"
                    return 1
                fi
            }

            # å®Œæ•´å›é€€å‡½æ•°ï¼ˆåŒå±‚å›é€€ç­–ç•¥ï¼‰
            perform_complete_rollback() {
                echo "ğŸ†˜ Complete Rollback Process Starting..."

                # ç¬¬ä¸€å±‚ï¼šå°è¯• Docker é•œåƒå›é€€
                if rollback_docker_image; then
                    echo "  âœ… Docker image rollback completed."

                    # éªŒè¯ Docker é•œåƒå›é€€ç»“æœ
                    echo "  ğŸ¥ Verifying Docker rollback with health check..."
                    if perform_health_check "$HEALTH_CHECK_URL"; then
                        echo "  ğŸ‰ Docker rollback successful! Service is healthy."
                        return 0
                    else
                        echo "  âš ï¸ Docker rollback verification failed, trying file-level rollback..."
                    fi
                fi

                # ç¬¬äºŒå±‚ï¼šå°è¯•æ–‡ä»¶çº§å›é€€
                if rollback_build_files; then
                    echo "  âœ… File-level rollback completed."

                    # éªŒè¯æ–‡ä»¶çº§å›é€€ç»“æœ
                    echo "  ğŸ¥ Verifying file rollback with health check..."
                    if perform_health_check "$HEALTH_CHECK_URL"; then
                        echo "  ğŸ‰ File rollback successful! Service is healthy."
                        return 0
                    else
                        echo "  ğŸ’¥ File rollback verification failed!"
                    fi
                else
                    echo "  ğŸ’¥ File-level rollback failed!"
                fi

                echo "  ğŸš¨ Complete rollback failed! Manual intervention required."
                return 1
            }

            # =====================================================
            # ä¸»å¥åº·æ£€æŸ¥å’Œéƒ¨ç½²éªŒè¯æµç¨‹
            # =====================================================

            # æ£€æŸ¥éƒ¨ç½²æ˜¯å¦æˆåŠŸå¹¶è¿›è¡Œå¥åº·éªŒè¯
            if [ "$DOCKER_DEPLOY_FAILED" = "true" ]; then
                echo "ğŸ’¥ Skipping health check due to Docker deployment failure."
                echo "ğŸ†˜ Initiating immediate rollback..."

                if perform_complete_rollback; then
                    echo "âœ… Rollback completed successfully."
                    exit 0
                else
                    echo "ğŸ’¥ Rollback failed! Manual intervention required."
                    exit 1
                fi
            else
                # æ‰§è¡Œå¥åº·æ£€æŸ¥
                echo "ğŸ¥ Health Check Phase:"
                if perform_health_check "$HEALTH_CHECK_URL"; then
                    HEALTH_CHECK_PASSED=true
                    echo "  ğŸ‰ Health check passed! Deployment successful."
                else
                    HEALTH_CHECK_PASSED=false
                    echo "  ğŸ’¥ Health check failed! Initiating rollback..."
                fi
            fi

            # =====================================================
            # éƒ¨ç½²ç»“æœå¤„ç†å’Œæœ€ç»ˆçŠ¶æ€æŠ¥å‘Š
            # =====================================================

            if [ "$HEALTH_CHECK_PASSED" = "true" ]; then
                # éƒ¨ç½²æˆåŠŸæµç¨‹
                echo ""
                echo "ğŸ“¦ Post-Deployment Backup Phase:"
                echo "  âœ“ Creating timestamped backup..."
                if [ -f build.tar.gz ]; then
                    cp build.tar.gz "$VERSION_BACKUP"
                    echo "  âœ“ New version backed up as: $VERSION_BACKUP"
                    rm build.tar.gz
                    echo "  âœ“ Original build.tar.gz cleaned up."

                    # æ¸…ç†æ—§å¤‡ä»½æ–‡ä»¶ï¼Œåªä¿ç•™æœ€è¿‘çš„ä¸¤ä»½
                    echo "  ğŸ§¹ Cleaning up old backup files (keeping latest 2)..."
                    ls -t build-backup-*.tar.gz 2>/dev/null | tail -n +3 | xargs -r rm || true
                    echo "  âœ… Backup cleanup completed."
                else
                    echo "  âš ï¸ No build.tar.gz found for backup."
                fi
                echo ""

                echo "ğŸ§¹ Docker Cleanup Phase:"
                echo "  ğŸ—‘ï¸ Cleaning up old Docker images..."

                # åˆ é™¤é™¤äº† current å’Œ previous ä¹‹å¤–çš„æ‰€æœ‰æ—§é•œåƒ
                docker images "$APP_NAME" --format "{{.Repository}}:{{.Tag}}" | \
                grep -v -E ":current$|:previous$|:backup-" | \
                xargs -r docker rmi 2>/dev/null || true

                # æ¸…ç†æ‚¬ç©ºé•œåƒ
                docker image prune -f
                echo "  âœ… Image cleanup completed."
                echo ""

                # æˆåŠŸçŠ¶æ€æŠ¥å‘Š
                echo "ğŸ‰ === DEPLOYMENT SUCCESSFUL === ğŸ‰"
                echo "Version: $VERSION deployed successfully"
                echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
                echo "Docker Image: $NEW_IMAGE_TAG"
                echo "Status: All systems operational"
                echo "Health Check: âœ… PASSED"
                echo "Backup Available: âœ… $VERSION_BACKUP"
                echo "Previous Image: âœ… $PREVIOUS_IMAGE_TAG"
                echo "=================================================="
                exit 0

            else
                # éƒ¨ç½²å¤±è´¥æµç¨‹ - æ‰§è¡Œå›é€€
                echo ""
                echo "ğŸ†˜ Deployment failed! Executing rollback strategy..."

                if perform_complete_rollback; then
                    echo ""
                    echo "âš ï¸ === DEPLOYMENT ROLLED BACK === âš ï¸"
                    echo "Version: $VERSION deployment failed"
                    echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
                    echo "Status: Rollback successful, service restored"
                    echo "Action Taken: Automatic recovery completed"
                    echo "Health Check: âœ… PASSED (after rollback)"
                    echo "=============================================="
                    exit 0
                else
                    echo ""
                    echo "ğŸ’¥ === DEPLOYMENT FAILED === ğŸ’¥"
                    echo "Version: $VERSION deployment failed"
                    echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
                    echo "Status: Rollback failed - Manual intervention required"
                    echo "Action Required: Check logs above for details"
                    echo "Health Check: âŒ FAILED"
                    echo "Rollback Status: âŒ FAILED"
                    echo "========================================="
                    exit 1
                fi
            fi
